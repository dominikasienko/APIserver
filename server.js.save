const express = require('express');
const cors = require('cors'); // Teraz moduł 'cors' jest dostępny!
const axios = require('axios');
const qs = require('qs');

// Wczytywanie zmiennych środowiskowych z pliku .env w środowisku lokalnym
// Na Render.com zmienne są automatycznie wstrzykiwane
require('dotenv').config();

const app = express();
const PORT = process.env.PORT || 3000;

// Klucze API
const CLIENT_ID = process.env.FATSECRET_CLIENT_ID;
const CLIENT_SECRET = process.env.FATSECRET_CLIENT_SECRET;

// Adresy API FatSecret
const TOKEN_URL = 'https://oauth.fatsecret.com/connect/token';
const SEARCH_URL = 'https://platform.fatsecret.com/rest/server.api';

// Włączanie CORS dla wszystkich domen
app.use(cors());

// Middleware do parsowania JSON w ciele żądania
app.use(express.json());

// Prosta ścieżka testowa
app.get('/', (req, res) => {
    res.status(200).send('FatSecret Nutrition Proxy is running.');
});

/**
 * Krok 1: Pobiera token dostępu OAuth 2.0 od FatSecret.
 */
async function getAccessToken() {
    if (!CLIENT_ID || !CLIENT_SECRET) {
        throw new Error("FATSECRET_CLIENT_ID lub FATSECRET_CLIENT_SECRET nie są ustawione w zmiennych środowiskowych.");
    }
    
    const tokenData = qs.stringify({
        grant_type: 'client_credentials',
        scope: 'basic'
    });

    try {
        const response = await axios.post(TOKEN_URL, tokenData, {
            headers: {
                'Authorization': `Basic ${Buffer.from(`${CLIENT_ID}:${CLIENT_SECRET}`).toString('base64')}`,
                'Content-Type': 'application/x-www-form-urlencoded'
            }
        });
        
        return response.data.access_token;
    } catch (error) {
        console.error('Błąd pobierania tokena FatSecret:', error.response?.data || error.message);
        throw new Error('Nie udało się pobrać tokena dostępu z FatSecret.');
    }
}

/**
 * Krok 2: Pobiera informacje odżywcze z FatSecret.
 */
app.post('/api/nutrition', async (req, res) => {
    const { ingredients, servings } = req.body;

    if (!ingredients || !Array.isArray(ingredients) || ingredients.length === 0) {
        return res.status(400).json({ error: "Brak listy składników ('ingredients') w ciele żądania." });
    }

    if (typeof servings !== 'number' || servings <= 0) {
        return res.status(400).json({ error: "Nieprawidłowa wartość 'servings'." });
    }

    let accessToken;
    try {
        accessToken = await getAccessToken();
    } catch (error) {
        return res.status(500).json({ error: error.message });
    }
    
    // Zsumowane wartości odżywcze
    let totalCalories = 0;
    let totalFat = 0;
    let totalCarbohydrates = 0;
    let totalProtein = 0;
    
    // Używamy Promise.all do równoległego przetwarzania zapytań
    try {
        const searchPromises = ingredients.map(async (ingredientString) => {
            console.log(`Wyszukiwanie: ${ingredientString}`);
            
            const params = {
                method: 'food.find_id_for_serving_phrase',
                phrase: ingredientString,
                format: 'json',
                serving_phrase: ingredientString
            };

            // Wymagany format FatSecret: application/x-www-form-urlencoded
            const response = await axios.post(SEARCH_URL, qs.stringify(params), {
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/x-www-form-urlencoded'
                }
            });

            // Odpowiedź zawiera 'serving_phrase_id' i 'nutrition_per_serving'
            const data = response.data;
            
            if (data.nutrition_per_serving) {
                const nutrition = data.nutrition_per_serving;
                
                // Konwersja na liczby i sumowanie, ignorując 'fiber', 'sugar', 'sodium' itp.
                totalCalories += parseFloat(nutrition.calories) || 0;
                totalFat += parseFloat(nutrition.fat) || 0;
                totalCarbohydrates += parseFloat(nutrition.carbohydrate) || 0;
                totalProtein += parseFloat(nutrition.protein) || 0;
            } else {
                console.warn(`Ostrzeżenie: Nie znaleziono danych odżywczych dla: ${ingredientString}`);
                // Możesz chcieć zwrócić błąd 400 jeśli żaden składnik nie został znaleziony
            }
        });
        
        await Promise.all(searchPromises);
        
        // Obliczanie wartości NA PORCJĘ
        const caloriesPerServing = totalCalories / servings;
        const fatPerServing = totalFat / servings;
        const carbohydratesPerServing = totalCarbohydrates / servings;
        const proteinPerServing = totalProtein / servings;

        // Zwrot wyniku zgodny ze strukturą NutritionInfo z pliku Swift
        res.json({
            calories: caloriesPerServing,
            fat: fatPerServing,
            carbohydrates: carbohydratesPerServing,
            protein: proteinPerServing
        });

    } catch (error) {
        console.error('Główny błąd przetwarzania:', error.message);
        const status = error.response?.status || 500;
        const message = error.response?.data?.error?.message || 'Wewnętrzny błąd serwera podczas przetwarzania danych odżywczych.';
        
        res.status(status).json({ error: message });
    }
});

// Uruchomienie serwera
app.listen(PORT, () => {
    console.log(`Serwer proxy działa na porcie ${PORT}`);
});

